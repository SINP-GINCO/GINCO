# Config for Mapserv
ScriptAlias "/mapserv_@instance.name@.ginco" "/usr/lib/cgi-bin/mapserv"

# Hide server signature and information on server
ServerSignature Off
ServerTokens Prod

<Location "/mapserv_@instance.name@.ginco">
	Options +ExecCGI +SymLinksIfOwnerMatch
	#SetHandler fcgid-script
	SetEnv MS_MAPFILE "/var/www/@instance.name@/mapserver/ginco_@instance.name@.map"
	SetEnv MS_ERRORFILE "/var/www/@instance.name@/website/logs/mapserver_error.log"
	SetEnv MS_DEBUGLEVEL 3
	Order allow,deny
	Allow from all
</Location>

<VirtualHost *:80>

	# Need for the file indexation post process
	# 9h = 32400s
	TimeOut 32400

	# environment [production] or [development] or [instance.name]
	SetEnv APPLICATION_ENV @app.env@

	# The name of the server
	ServerName @http.host.name@.ign.fr

	# The aliases are here used for parallelized computation of map tiles
	ServerAlias @http.host.name@.ign.fr
	ServerAlias @http.host.name@-1.ign.fr
	ServerAlias @http.host.name@-2.ign.fr
	ServerAlias @http.host.name@-3.ign.fr
	ServerAlias @http.host.name@-4.ign.fr
	ServerAlias @http.host.name@-5.ign.fr
	ServerAlias @http.host.name@-6.ign.fr
	ServerAlias @http.host.name@-7.ign.fr
	ServerAlias @http.host.name@-8.ign.fr
	ServerAlias @http.host.name@-9.ign.fr

	# Log files
	ErrorLog /var/www/@instance.name@/website/logs/error.log
	CustomLog /var/www/@instance.name@/website/logs/access.log common
	#CustomLog /var/www/@instance.name@/website/logs/access.log combinedio

	# Configure php.ini
	php_value memory_limit 512M
	php_value post_max_size 100M
	php_value upload_max_size 100M
	php_value date.timezone "Europe/Paris"
	php_value session.name "@instance.name@_GINCO_SID"
	php_value session.save_path "/var/www/@instance.name@/website/server/ogamServer/sessions/"

	DocumentRoot /var/www/@instance.name@/website/public

	# a partir de apache 2.4 les logs de tous les modules sont redirigés dans les logs apaches
	# RewriteLog n'existe plus. RewriteLogLevel est remplacé par LogLevel rewrite <level> ...
	# RewriteLog "/var/www/@instance.name@/website/logs/rewrite.log"
	# RewriteLogLevel 9

    ProxyPass /geosource http://localhost:8080/geosource
    ProxyPassReverse /geosource http://localhost:8080/geosource
    ProxyPassReverseCookiePath /geosource /geosource
    ProxyPassReverseCookieDomain localhost @http.host.name@.ign.fr


	<Directory "/var/www/@instance.name@/website/public">

		Options -Indexes +FollowSymLinks -MultiViews

		<IfVersion < 2.3 >
		  Order allow,deny
		  Allow from all
		</IfVersion>
		<IfVersion >= 2.3 >
		  Require all granted
		</IfVersion>
		AllowOverride all

		RewriteEngine On

		# Redirect urls beginning by index to general index
		RewriteRule ^index$ / [L,R=301]
        RewriteRule ^index/.*$ / [L,R=301]

		# Check if the requested file exist into the "custom" directory
		RewriteCond         /var/www/@instance.name@/website/custom/public/$1  -f
		# If true, we redirect to the custom file using the "custom" alias and we ended the redirection
		RewriteRule  ^(.+)  /custom/$1  [NC,L]

		# Real file
		RewriteCond %{REQUEST_FILENAME} -s [OR]
		# Symbolic link
		RewriteCond %{REQUEST_FILENAME} -l [OR]
		# Directory
		RewriteCond %{REQUEST_FILENAME} -d
		RewriteRule ^.*$ - [NC,L]
		RewriteRule ^.*$ index.php [NC,L]
		#RewriteRule !/.(js|ico|gif|jpg|jpeg|png|css|pdf|doc|ppt|csv|xls|xml)$ index.php

		# Activate the Expires headers generation
		ExpiresActive On
		ExpiresDefault           "access plus 1 week"
		ExpiresByType image/gif "access plus 1 year"
		ExpiresByType image/png "access plus 1 year"
		ExpiresByType image/x-icon "access plus 1 year"

	</Directory>

	## Alias Ogam Desktop Production (Visu)
	Alias "/odp" "/var/www/@instance.name@/website/public/OgamDesktop"
    <Directory "/var/www/@instance.name@/website/public/OgamDesktop">
		Options -Indexes +FollowSymLinks -MultiViews
		<IfVersion < 2.3 >
		  Order allow,deny
		  Allow from all
		</IfVersion>
		<IfVersion >= 2.3 >
		  Require all granted
		</IfVersion>
    </Directory>

	## Alias Ogam Desktop version développement
	Alias "/odd" "/var/www/@instance.name@/website/client/build/development/OgamDesktop"
    <Directory "/var/www/@instance.name@/website/client/build/development/OgamDesktop">
		Options Indexes FollowSymLinks MultiViews
		<IfVersion < 2.3 >
		  Order allow,deny
		  Allow from all
		</IfVersion>
		<IfVersion >= 2.3 >
		  Require all granted
		</IfVersion>
		#AllowOverride All
    </Directory>

	## Alias pointant sur la version customisée des fichiers
	Alias "/custom" "/var/www/@instance.name@/website/custom/public"
	<Directory "/var/www/@instance.name@/website/custom/public">
		AllowOverride all
		<IfVersion < 2.3 >
          Order allow,deny
          Allow from all
        </IfVersion>
        <IfVersion >= 2.3 >
          Require all granted
        </IfVersion>
	</Directory>

	## Alias pour le configurateur
	Alias /configurateur "/var/www/@instance.name@/configurator"
	<Directory "/var/www/@instance.name@/configurator">
		Options Indexes FollowSymLinks MultiViews
		AllowOverride All
		<IfVersion < 2.3 >
          Order allow,deny
          Allow from all
        </IfVersion>
        <IfVersion >= 2.3 >
          Require all granted
        </IfVersion>
	</Directory>

</VirtualHost>
